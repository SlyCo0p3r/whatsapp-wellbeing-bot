services:
  # Conteneur init : clone le repo et prÃ©pare l'environnement
  init-repo:
    image: alpine/git:latest
    container_name: whatsapp-bot-init
    volumes:
      - /mnt/user/appdata/whatsapp-wellbeing-bot:/workspace
    working_dir: /workspace
    command: >
      sh -c "
        echo 'ðŸš€ Initialisation du projet WhatsApp Wellbeing Bot';
        mkdir -p /workspace;
        cd /workspace;
        if [ ! -f app.py ]; then
          echo 'ðŸ“¥ Clonage du dÃ©pÃ´t depuis GitHub...';
          rm -rf * .* 2>/dev/null || true;
          git clone --depth 1 https://github.com/SlyCo0p3r/whatsapp-wellbeing-bot.git temp_repo;
          mv temp_repo/* temp_repo/.git* . 2>/dev/null || true;
          rm -rf temp_repo;
          echo 'âœ… DÃ©pÃ´t clonÃ© avec succÃ¨s';
        else
          echo 'âœ… Code dÃ©jÃ  prÃ©sent';
        fi;
        if [ ! -f .env ]; then
          echo 'ðŸ“ CrÃ©ation du fichier .env depuis .env.example...';
          cp .env.example .env 2>/dev/null || touch .env;
          echo 'âš ï¸  IMPORTANT: Ã‰ditez /mnt/user/appdata/whatsapp-wellbeing-bot/.env avec vos valeurs';
        else
          echo 'âœ… Fichier .env existe dÃ©jÃ ';
        fi;
        mkdir -p data;
        chmod -R 755 data 2>/dev/null || true;
        echo 'âœ… Initialisation terminÃ©e';
      "
    restart: "no"

  # Conteneur principal de l'application
  whatsapp-wellbeing-bot:
    build: 
      context: /mnt/user/appdata/whatsapp-wellbeing-bot
      dockerfile: Dockerfile
    container_name: whatsapp-wellbeing-bot
    depends_on:
      init-repo:
        condition: service_completed_successfully
    volumes:
      - /mnt/user/appdata/whatsapp-wellbeing-bot/data:/app/data
    env_file:
      - /mnt/user/appdata/whatsapp-wellbeing-bot/.env
    restart: unless-stopped
    ports:
      - "5090:5000"
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:5000/health', timeout=5)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
