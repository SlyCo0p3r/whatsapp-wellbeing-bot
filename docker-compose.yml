services:
  init-repo:
    image: alpine/git:latest
    container_name: whatsapp-bot-init
    volumes:
      - /mnt/user/appdata/whatsapp-wellbeing-bot:/workspace
    working_dir: /workspace
    command: >
      sh -c "
        echo 'Initialisation du projet WhatsApp Wellbeing Bot';
        mkdir -p /workspace;
        cd /workspace;
        if [ ! -f app.py ]; then
          echo 'Clonage du depot depuis GitHub...';
          rm -rf * .* 2>/dev/null || true;
          git clone --depth 1 https://github.com/SlyCo0p3r/whatsapp-wellbeing-bot.git temp_repo || exit 1;
          if [ ! -d temp_repo ]; then
            echo 'ERREUR: Le clonage a echoue';
            exit 1;
          fi;
          mv temp_repo/* . 2>/dev/null || true;
          mv temp_repo/.git* . 2>/dev/null || true;
          rm -rf temp_repo;
          if [ ! -f Dockerfile ]; then
            echo 'ERREUR: Dockerfile non trouve apres le clonage';
            ls -la;
            exit 1;
          fi;
          echo 'Depot clone avec succes';
        else
          echo 'Code deja present';
        fi;
        if [ ! -f .env ]; then
          echo 'Creation du fichier .env depuis .env.example...';
          if [ -f .env.example ]; then
            cp .env.example .env;
          else
            echo '# Configuration WhatsApp Wellbeing Bot' > .env;
            echo 'WHATSAPP_TOKEN=' >> .env;
            echo 'WHATSAPP_PHONE_ID=' >> .env;
            echo 'WEBHOOK_VERIFY_TOKEN=' >> .env;
            echo 'OWNER_PHONE=' >> .env;
            echo 'ALERT_PHONES=' >> .env;
            echo 'DAILY_HOUR=9' >> .env;
            echo 'RESPONSE_TIMEOUT_MIN=120' >> .env;
            echo 'TZ=Europe/Paris' >> .env;
            echo 'CORS_ORIGINS=http://localhost' >> .env;
            echo 'USE_GUNICORN=false' >> .env;
          fi;
          echo 'IMPORTANT: Editez /mnt/user/appdata/whatsapp-wellbeing-bot/.env avec vos valeurs';
        else
          echo 'Fichier .env existe deja';
        fi;
        mkdir -p data;
        chmod -R 755 data 2>/dev/null || true;
        if [ ! -f Dockerfile ]; then
          echo 'ERREUR: Dockerfile non trouve apres le clonage';
          exit 1;
        fi;
        echo 'Initialisation terminee';
      "
    restart: "no"

  whatsapp-wellbeing-bot:
    build:
      context: /mnt/user/appdata/whatsapp-wellbeing-bot
      dockerfile: Dockerfile
    container_name: whatsapp-wellbeing-bot
    depends_on:
      init-repo:
        condition: service_completed_successfully
    volumes:
      - /mnt/user/appdata/whatsapp-wellbeing-bot/data:/app/data
    env_file:
      - /mnt/user/appdata/whatsapp-wellbeing-bot/.env
    restart: unless-stopped
    ports:
      - "5090:5000"
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:5000/health', timeout=5)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
